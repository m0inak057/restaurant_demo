{% extends "core/base.html" %}

{% block title %}Order · Table {{ table.table_number }}{% endblock %}

{% block content %}
  <section class="mb-6 flex flex-wrap items-center justify-between gap-3">
    <div>
      <p class="text-[11px] uppercase tracking-[0.2em] text-slate-400">
        Table {{ table.table_number }} · {{ table.get_status_display|title }}
      </p>
      <h1 class="mt-1 text-xl font-semibold text-slate-50">Create order</h1>
      <p class="mt-1 text-xs text-slate-400">
        Adjust quantities, add notes for the chef, and send directly to the
        kitchen.
      </p>
    </div>
    <div class="flex flex-col items-end text-xs text-slate-400">
      <span>Guests at table: {{ table.capacity }}</span>
    </div>
  </section>

  <section class="glass-card grid gap-6 p-4 md:grid-cols-[minmax(0,2fr)_minmax(0,1.2fr)] md:p-6">
    <form id="order-form" class="space-y-4">
      <input type="hidden" name="table_id" value="{{ table.id }}" />
      <div class="max-h-80 space-y-3 overflow-y-auto pr-1">
        {% for item in items %}
        <article
          class="flex items-start justify-between gap-3 rounded-2xl border border-white/10 bg-slate-900/60 px-3 py-2.5"
        >
          <div class="flex-1">
            <h2 class="text-sm font-semibold text-slate-50">
              {{ item.name }}
            </h2>
            <p class="mt-0.5 text-[11px] text-slate-400">
              {{ item.description|default:"Crafted in our open kitchen." }}
            </p>
            <textarea
              name="note_{{ item.id }}"
              rows="1"
              class="mt-1 w-full rounded-xl border border-slate-700/70 bg-slate-900/80 px-2 py-1 text-[11px] text-slate-100 placeholder:text-slate-500 focus:border-emerald-400/70 focus:outline-none"
              placeholder="Optional note for the chef (e.g. no onions, extra spicy)"
            ></textarea>
          </div>
          <div class="flex flex-col items-end gap-1">
            <span class="text-xs font-semibold text-emerald-300">
              ₹ {{ item.price }}
            </span>
            <div class="inline-flex items-center rounded-full bg-slate-950/80 px-2 py-1">
              <button
                type="button"
                class="qty-btn text-sm text-slate-300"
                data-target="quantity_{{ item.id }}"
                data-delta="-1"
              >
                −
              </button>
              <input
                type="number"
                min="0"
                name="quantity_{{ item.id }}"
                value="0"
                class="w-10 border-none bg-transparent text-center text-xs text-slate-100 focus:outline-none"
              />
              <button
                type="button"
                class="qty-btn text-sm text-emerald-400"
                data-target="quantity_{{ item.id }}"
                data-delta="1"
              >
                +
              </button>
            </div>
          </div>
        </article>
        {% endfor %}
      </div>
      <p class="text-[11px] text-slate-500">
        Tip: set quantities first, then hit "Send to kitchen".
      </p>
    </form>

    <aside class="flex flex-col justify-between rounded-2xl bg-slate-950/70 p-4">
      <div>
        <h2 class="text-sm font-semibold text-slate-50">Order summary</h2>
        <ul
          id="summary-list"
          class="mt-3 max-h-48 space-y-2 overflow-y-auto text-xs text-slate-300"
        ></ul>
        <div
          class="mt-3 flex items-center justify-between border-t border-white/10 pt-3 text-sm"
        >
          <span class="text-slate-400">Estimated total</span>
          <span id="summary-total" class="font-semibold text-slate-50"
            >₹ 0</span
          >
        </div>
      </div>
      <div class="mt-4 space-y-2 text-xs">
        <button
          type="button"
          id="submit-order"
          class="flex w-full items-center justify-center rounded-full bg-emerald-500 px-4 py-2 text-sm font-semibold text-slate-950 shadow-lg shadow-emerald-500/40 hover:bg-emerald-400"
        >
          Send to kitchen
        </button>
        <p id="result" class="text-[11px] text-slate-400"></p>
      </div>
    </aside>
  </section>

  <script>
    const form = document.getElementById("order-form");
    const summaryList = document.getElementById("summary-list");
    const summaryTotal = document.getElementById("summary-total");
    const resultBox = document.getElementById("result");
    const submitBtn = document.getElementById("submit-order");

    const priceMap = {
      {% for item in items %}
      {{ item.id }}: {{ item.price }}{% if not forloop.last %},{% endif %}
      {% endfor %}
    };

    function recalcSummary() {
      const formData = new FormData(form);
      const entries = [];
      let total = 0;

      {% for item in items %}
      const q{{ item.id }} = parseInt(
        formData.get("quantity_{{ item.id }}") || "0",
        10,
      );
      if (q{{ item.id }} > 0) {
        const line = q{{ item.id }} * priceMap[{{ item.id }}];
        total += line;
        entries.push(
          `${q{{ item.id }}} × {{ item.name|escapejs }} · ₹ ${line}`,
        );
      }
      {% endfor %}

      summaryList.innerHTML = "";
      if (entries.length === 0) {
        summaryList.innerHTML =
          '<li class="text-slate-500">No items selected yet.</li>';
      } else {
        entries.forEach((t) => {
          const li = document.createElement("li");
          li.textContent = t;
          summaryList.appendChild(li);
        });
      }
      summaryTotal.textContent = `₹ ${total}`;
    }

    document.querySelectorAll(".qty-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const targetName = btn.dataset.target;
        const delta = parseInt(btn.dataset.delta, 10) || 0;
        const input = form.querySelector(`[name="${targetName}"]`);
        if (!input) return;
        let value = parseInt(input.value || "0", 10) || 0;
        value = Math.max(0, value + delta);
        input.value = value;
        recalcSummary();
      });
    });

    form.addEventListener("change", recalcSummary);
    recalcSummary();

    submitBtn.addEventListener("click", async () => {
      const formData = new FormData(form);
      const tableId = formData.get("table_id");
      const items = [];

      {% for item in items %}
      const q{{ item.id }} = parseInt(
        formData.get("quantity_{{ item.id }}") || "0",
        10,
      );
      if (q{{ item.id }} > 0) {
        items.push({
          menu_item_id: {{ item.id }},
          quantity: q{{ item.id }},
          custom_notes: formData.get("note_{{ item.id }}") || "",
        });
      }
      {% endfor %}

      if (!items.length) {
        resultBox.textContent = "Please select at least one item.";
        resultBox.classList.remove("text-emerald-300");
        resultBox.classList.add("text-red-400");
        return;
      }

      const payload = {
        table_id: parseInt(tableId, 10),
        items,
        special_instructions: "",
      };

      submitBtn.disabled = true;
      submitBtn.textContent = "Sending...";
      resultBox.textContent = "";

      try {
        const response = await fetch("/api/orders/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(payload),
        });

        const data = await response.json();
        if (response.ok) {
          resultBox.textContent =
            "Order placed! Tracking at " +
            window.location.origin +
            "/order/track/" +
            data.id +
            "/";
          resultBox.classList.remove("text-red-400");
          resultBox.classList.add("text-emerald-300");
        } else {
          resultBox.textContent =
            "Something went wrong: " + JSON.stringify(data);
          resultBox.classList.remove("text-emerald-300");
          resultBox.classList.add("text-red-400");
        }
      } catch (err) {
        resultBox.textContent = "Network error. Please try again.";
        resultBox.classList.remove("text-emerald-300");
        resultBox.classList.add("text-red-400");
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "Send to kitchen";
      }
    });
  </script>
{% endblock %}
